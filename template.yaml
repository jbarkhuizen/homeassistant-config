- trigger:
    - platform: time_pattern
      seconds: "/5"
  sensor:
# Below sensors were identified to be duplicated for Sunsynk in the smartdeyedongle.yaml
#Commented out on 4 Aug 2025
# Below Sensors were added for the Sunsynk Integration  
#    - name: "deyeinvertermaster_solar_power_used"
#      state: "{{ (states('sensor.deyeinvertermaster_summary_day_pv') | float(1) - states('sensor.deyeinvertermaster_solar_power_battery_charge') | float(1)) |round(1) }}"
#      unit_of_measurement: "kWh"
#      device_class: energy
#      state_class: total_increasing
#
#    - name: "deyeinvertermaster_solar_power_battery_charge"
#      state: "{{ ( states('sensor.deyeinvertermaster_summary_day_battery_charge') | float(1) - states('sensor.deyeinvertermaster_summary_day_battery_charge_grid') | float(1)) | round(1) }}"
#      unit_of_measurement: "kWh"
#      device_class: energy
#      state_class: total_increasing

#---------------------------------------------------------------------------------------      

#    #essential = inverter_power_175 + grid_power_169  - aux_power_166
#    - name: "deyeinvertermaster_essential_load"
#      state: "{{ (states('sensor.deyeinvertermaster_inverter_output_power') |float(0)  + (states('sensor.deyeinvertermaster_grid_load_l1') |float(0) - states('sensor.deyeinvertermaster_aux_output_power') |float(0) )) | round(0)}}"
#      unit_of_measurement: "W"
#      device_class: power
#      state_class: measurement
#
#    #nonessential = grid_ct_power_172 - grid_power_167 (L1)
#    - name: "deyeinvertermaster_non_essential_load"
#      state: "{{ (states('sensor.deyeinvertermaster_grid_power_ct_clamp') |float(0)  - (states('sensor.deyeinvertermaster_grid_load_l1') |float(0))) | round(0)}}"
#      unit_of_measurement: "W"
#      device_class: power
#      state_class: measurement
#
#    - name: "deyeinvertermaster_priority_charge_or_load"
#      state: |
#        {% if is_state('select.deyeinvertermaster_energy_management_model', 'Battery Priority Mode') %}
#          off
#        {% else %}
#          on
#        {% endif %}

#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Claude.ai recommended that the below code 44-53 is replaced with code 54-66 on 4 Aug 2025        
#    - name: deyeinvertermaster_battery_charge_grid_power
#      unit_of_measurement: "kW"
#      state_class: measurement
#      device_class: power
#      state: >-
#        {% if states('sensor.deyeinvertermaster_inverter_output_power')|float < 0.0 %}
#        {{ (states('sensor.deyeinvertermaster_battery_output_power') | float(4) | abs ) * 0.001  }}
#        {% else %}
#        0.0
#        {% endif %}
#    - name: deyeinvertermaster_battery_charge_grid_power
#      unit_of_measurement: "kW"
#      state_class: measurement
#      device_class: power
#      state: >-
#              {% if states('sensor.deyeinvertermaster_inverter_output_power') | float(0) < 0.0 %}
#                {{ (states('sensor.deyeinvertermaster_battery_output_power') | float(0) | abs ) * 0.001  }}
#              {% else %}
#                0.0
#              {% endif %}
#      availability: >-
#              {{ has_value('sensor.deyeinvertermaster_inverter_output_power') and 
#                has_value('sensor.deyeinvertermaster_battery_output_power') }}
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#    - name: "deyeinvertermaster_ha_time"
#      state: |
#        {{ now().strftime('%y%m%d%H%M') }}
#
#    ####################Slave

    # - name: "deyeinverterslave_solar_power_used"
    #   state: "{{ (states('sensor.deyeinverterslave_summary_day_pv') | float(0) - states('sensor.deyeinverterslave_summary_day_battery_charge') | float(0)) |round(1) }}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # #essential = deyeinverterslave_power_175 + grid_power_169  - aux_power_166
    # - name: "deyeinverterslave_essential_load"
    #   state: "{{ (states('sensor.deyeinverterslave_deyeinverterslave_output_power') |float(0)  + (states('sensor.deyeinverterslave_grid_load') |float(0) - states('sensor.deyeinverterslave_aux_output_power') |float(0) )) | round(0)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # #nonessential = grid_ct_power_172 - grid_power_167 (L1)
    # - name: "deyeinverterslave_non_essential_load"
    #   state: "{{ (states('sensor.deyeinverterslave_grid_power_ct_clamp') |float(0)  - (states('sensor.deyeinverterslave_grid_load') |float(0))) | round(0)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinverterslave_priority_charge_or_load"
    #   state: |
    #     {% if is_state('select.deyeinverterslave_energy_management_model', 'Battery Priority Mode') %}
    #       off
    #     {% else %}
    #       on
    #     {% endif %}

    # - name: deyeinverterslave_battery_charge_grid_power
    #   unit_of_measurement: "kW"
    #   state_class: measurement
    #   device_class: power
    #   state: >-
    #     {% if states('sensor.deyeinverterslave_inverter_output_power')|float < 0.0 %}
    #     {{ (states('sensor.deyeinverterslave_battery_output_power') | float(4) | abs ) * 0.001  }}
    #     {% else %}
    #     0.0
    #     {% endif %}

    # #Combined entities for the summary view with Master/Slave inverters
    # - name: "deyeinvertercombined_battery_soc"
    #   state: |-
    #     {% if (has_value('sensor.deyeinvertermaster_battery_soc') and has_value('sensor.deyeinverterslave_battery_soc')) %}
    #     {{  (states('sensor.deyeinvertermaster_battery_soc') |float(1)  + (states('sensor.deyeinverterslave_battery_soc') |float(1)))  / 2.0 }}
    #     {% else %}
    #     {{0.0}}
    #     {% endif %}
    #   availability: >-
    #     {{ (has_value('sensor.deyeinvertermaster_battery_soc') and has_value('sensor.deyeinverterslave_battery_soc')) }}
    #   unit_of_measurement: "%"
    #   device_class: battery

    # - name: "deyeinvertercombined_battery_voltage"
    #   state: "{{ (states('sensor.deyeinvertermaster_battery_voltage') |float(1)  + (states('sensor.deyeinverterslave_battery_voltage') |float(1)))  / 2.0 }}"
    #   unit_of_measurement: "V"
    #   device_class: voltage

    # - name: "deyeinvertercombined_summary_day_battery_charge"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_battery_charge') |float(0)  + (states('sensor.deyeinverterslave_summary_day_battery_charge') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_load"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_load') |float(0)  + (states('sensor.deyeinverterslave_summary_day_load') |float(0))) | round(1) }}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing
    #   availability: >-
    #     {{ (has_value('sensor.deyeinvertermaster_summary_day_load') and has_value('sensor.deyeinverterslave_summary_day_load')) }}

    # - name: "deyeinvertercombined_summary_day_battery_discharge"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_battery_discharge') |float(0)  + (states('sensor.deyeinverterslave_summary_day_battery_discharge') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_pv"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_pv') |float(0)  + (states('sensor.deyeinverterslave_summary_day_pv') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing
    #   availability: >-
    #     {{ (has_value('sensor.deyeinvertermaster_summary_day_pv') and has_value('sensor.deyeinverterslave_summary_day_pv')) }}

    # - name: "deyeinvertercombined_summary_day_pv1"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_pv1') |float(0)  + (states('sensor.deyeinverterslave_summary_day_pv1') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_pv2"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_pv2') |float(0)  + (states('sensor.deyeinverterslave_summary_day_pv2') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_pv3"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_pv3') |float(0)  + (states('sensor.deyeinverterslave_summary_day_pv3') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_pv4"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_pv4') |float(0)  + (states('sensor.deyeinverterslave_summary_day_pv4') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_grid_import_buy"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_grid_import_buy') |float(0))}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_grid_import_buy_half"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_grid_import_buy') |float(0) / 2.0)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_day_grid_export_sell"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_day_grid_export_sell') |float(0) / 2.0)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_total_pv"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_total_pv') |float(3)  + (states('sensor.deyeinverterslave_summary_total_pv') |float(3))) | round(4)}}"
    #   unit_of_measurement: "MWh"
    #   device_class: energy
    #   state_class: total_increasing
    #   availability: >-
    #     {{ (has_value('sensor.deyeinvertermaster_summary_total_pv') and has_value('sensor.deyeinverterslave_summary_total_pv')) }}

    # - name: "deyeinvertercombined_summary_total_load"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_total_load') |float(3)  + (states('sensor.deyeinverterslave_summary_total_load') |float(3))) | round(4)}}"
    #   unit_of_measurement: "MWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_total_grid_import_buy"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_total_grid_import_buy') |float(3)) | round(4)}}"
    #   unit_of_measurement: "MWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_total_grid_export_sell"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_total_grid_export_sell') |float(3)) | round(4)}}"
    #   unit_of_measurement: "MWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_total_battery_discharge"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_total_battery_discharge') |float(3)  + (states('sensor.deyeinverterslave_summary_total_battery_discharge') |float(3))) | round(4)}}"
    #   unit_of_measurement: "MWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_summary_total_battery_charge"
    #   state: "{{ (states('sensor.deyeinvertermaster_summary_total_battery_charge') |float(3)  + (states('sensor.deyeinverterslave_summary_total_battery_charge') |float(3))) | round(4)}}"
    #   unit_of_measurement: "MWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_essential_load"
    #   state: "{{ (states('sensor.deyeinvertermaster_essential_load') |float(0) + (states('sensor.deyeinverterslave_essential_load') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_grid_load"
    #   state: "{{ (states('sensor.deyeinvertermaster_grid_load') |float(0) + (states('sensor.deyeinverterslave_grid_load') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_inverter_output_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_inverter_output_power') |float(0)  + (states('sensor.deyeinverterslave_inverter_output_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_battery_output_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_battery_output_power') |float(0)  + (states('sensor.deyeinverterslave_battery_output_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_solar_power_used"
    #   state: "{{ (states('sensor.deyeinvertermaster_solar_power_used') |float(0)  + (states('sensor.deyeinverterslave_solar_power_used') |float(0))) | round(1)}}"
    #   unit_of_measurement: "kWh"
    #   device_class: energy
    #   state_class: total_increasing

    # - name: "deyeinvertercombined_pv_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_pv_power') |float(0)  + (states('sensor.deyeinverterslave_pv_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement
    #   availability: >-
    #     {{ (has_value('sensor.deyeinvertermaster_pv_power') and has_value('sensor.deyeinverterslave_pv_power')) }}

    # - name: "deyeinvertercombined_pv1_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_pv1_power') |float(0)  + (states('sensor.deyeinverterslave_pv1_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_pv2_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_pv2_power') |float(0)  + (states('sensor.deyeinverterslave_pv2_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_pv3_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_pv3_power') |float(0)  + (states('sensor.deyeinverterslave_pv3_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_pv4_power"
    #   state: "{{ (states('sensor.deyeinvertermaster_pv4_power') |float(0)  + (states('sensor.deyeinverterslave_pv4_power') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_grid_power_ct_clamp"
    #   state: "{{ states('sensor.deyeinvertermaster_grid_power_ct_clamp') |float(0) + states('sensor.deyeinverterslave_grid_power_ct_clamp') |float(1) }}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: "deyeinvertercombined_battery_output_current"
    #   state: "{{ (states('sensor.deyeinvertermaster_battery_output_current') |float(0)  + (states('sensor.deyeinverterslave_battery_output_current') |float(0))) | round(1)}}"
    #   unit_of_measurement: "A"
    #   device_class: current
    #   state_class: measurement

    # - name: "deyeinvertercombined_non_essential_load"
    #   state: "{{ (states('sensor.deyeinvertermaster_non_essential_load') |float(0)  - (states('sensor.deyeinverterslave_non_essential_load') |float(0))) | round(1)}}"
    #   unit_of_measurement: "W"
    #   device_class: power
    #   state_class: measurement

    # - name: deyeinvertercombined_battery_charge_grid_power
    #   unit_of_measurement: "kW"
    #   state_class: measurement
    #   device_class: power
    #   state: >-
    #     {% if states('sensor.deyeinvertercombined_inverter_output_power')|float < 0.0 %}
    #     {{ (states('sensor.deyeinvertercombined_battery_output_power') | float(4) | abs ) * 0.001  }}
    #     {% else %}
    #     0.0
    #     {% endif %}

# Sensors below being created & added         
# added on 10 July 2025 @12h50
# Code Link 1.1 in sensor.yaml
    - name: "Plugs 2 Energy"
      state: "{{ states('sensor.plugs_2_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing    

    - name: "Plugs 1 Energy"
      state: "{{ states('sensor.plugs_1_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing      

    - name: "Plugs 3 Energy"
      state: "{{ states('sensor.plugs_2_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing  
      
    - name: "Woonstel Energy"
      state: "{{ states('sensor.woonstel_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing  

    - name: "Geyser New Energy"
      state: "{{ states('sensor.geyser_new_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing  

    - name: "Geyser External Energy"
      state: "{{ states('sensor.geyser_external_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing  

    - name: "Pool Pump Energy"
      state: "{{ states('sensor.pool_pump_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing

    - name: "Study Energy"
      state: "{{ states('sensor.study_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing

    - name: "Salon Energy"
      state: "{{ states('sensor.salon_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing

    - name: "Boorgat Energy"
      state: "{{ states('sensor.boorgat_energy') }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing

#------------------------------------------------------------------------------------------------------------------------
# Add by Co-Pilot to creates a sensor whose state is a list of all sensor entity IDs
    - name: "sensor_list"
      state: "{{ states.sensor | map(attribute='entity_id') | list }}"
#-----------------------------------------------------------------------------------------------------------
#MetroFibre Router Uptime
#Added by Claude.ai on 30 July 2025
 # Template Sensors for Uptime Calculation
    - name: "MetroFibre Router Uptime"
      state: >
        {% if is_state('binary_sensor.metrofibre_router', 'on') %}
          {{ ((as_timestamp(now()) - as_timestamp(states.binary_sensor.metrofibre_router.last_changed)) / 3600) | round(2) }}
        {% else %}
          0
        {% endif %}
      unit_of_measurement: "hours"
      icon: mdi:clock-outline
        
    - name: "Network Status Summary"
      state: >
        {% set routers = [
          'binary_sensor.metrofibre_router',
          'binary_sensor.tplink_eap245',
          'binary_sensor.netgear_genie',
          'binary_sensor.tplinl_archer_d2',
          'binary_sensor.tplink_eap225_outdoo',
          'binary_sensor.netgear_gs728tp'
        ] %}
        {% set online = routers | select('is_state', 'on') | list | length %}
        {% set total = routers | length %}
        {{ (online / total * 100) | round(1) }}
      unit_of_measurement: "%"
      icon: mdi:network-strength-4
#-----------------------------------------------------------------------------------------------------------          

#-----------------------------------------------------------------------------------------------------------
 
#-----------------------------------------------------------------------------------------------------------                  
# Template sensors for real-time bandwidth calculation (Add to configuration.yaml)
# Added by Claude.ai on 30 July 2025
 # ===================================================================
  # PORTS 1-6 BANDWIDTH MONITORING
  # ===================================================================
#    - trigger:
#      - platform: state
#        entity_id: 
#          - sensor.switch_port_1_bytes_out
#          - sensor.switch_port_1_bytes_in
#          - sensor.switch_port_2_bytes_out
#          - sensor.switch_port_2_bytes_in
#          - sensor.switch_port_3_bytes_out
#          - sensor.switch_port_3_bytes_in
#          - sensor.switch_port_4_bytes_out
#          - sensor.switch_port_4_bytes_in
#          - sensor.switch_port_5_bytes_out
#          - sensor.switch_port_5_bytes_in
#          - sensor.switch_port_6_bytes_out
#          - sensor.switch_port_6_bytes_in
#        not_to: ['unknown', 'unavailable']
#    - platform: time_pattern
#      seconds: "/30"
#      sensor:
      # Port 1 Sensors
    - name: "Port 1 Download Speed"
      unique_id: port_1_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_1_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_1_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_1_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 1"
          switch_port: 1

    - name: "Port 1 Upload Speed"
      unique_id: port_1_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_1_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_1_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_1_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 1"
          switch_port: 1

      # Port 2 Sensors
    - name: "Port 2 Download Speed"
      unique_id: port_2_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_2_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_2_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_2_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 2"
          switch_port: 2

    - name: "Port 2 Upload Speed"
      unique_id: port_2_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_2_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_2_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_2_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 2"
          switch_port: 2

      # Port 3 Sensors
    - name: "Port 3 Download Speed"
      unique_id: port_3_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_3_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_3_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_3_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 3"
          switch_port: 3

    - name: "Port 3 Upload Speed"
      unique_id: port_3_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_3_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_3_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_3_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 3"
          switch_port: 3

      # Port 4 Sensors
    - name: "Port 4 Download Speed"
      unique_id: port_4_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_4_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_4_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_4_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 4"
          switch_port: 4

    - name: "Port 4 Upload Speed"
      unique_id: port_4_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_4_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_4_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_4_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 4"
          switch_port: 4

      # Port 5 Sensors
    - name: "Port 5 Download Speed"
      unique_id: port_5_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_5_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_5_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_5_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 5"
          switch_port: 5

    - name: "Port 5 Upload Speed"
      unique_id: port_5_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_5_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_5_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_5_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 5"
          switch_port: 5

      # Port 6 Sensors
    - name: "Port 6 Download Speed"
      unique_id: port_6_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_6_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_6_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_6_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 6"
          switch_port: 6

    - name: "Port 6 Upload Speed"
      unique_id: port_6_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_6_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_6_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_6_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 6"
          switch_port: 6

  # ===================================================================
  # PORTS 7-12 BANDWIDTH MONITORING
  # ===================================================================
#    - trigger:
#      - platform: state
#        entity_id: 
#          - sensor.switch_port_7_bytes_out
#          - sensor.switch_port_7_bytes_in
#          - sensor.switch_port_8_bytes_out
#          - sensor.switch_port_8_bytes_in
#          - sensor.switch_port_9_bytes_out
#          - sensor.switch_port_9_bytes_in
#          - sensor.switch_port_10_bytes_out
#          - sensor.switch_port_10_bytes_in
#          - sensor.switch_port_11_bytes_out
#          - sensor.switch_port_11_bytes_in
#          - sensor.switch_port_12_bytes_out
#          - sensor.switch_port_12_bytes_in
#        not_to: ['unknown', 'unavailable']
#      - platform: time_pattern
#        seconds: "/30"
#        sensor:
#      # Port 7 Sensors
    - name: "Port 7 Download Speed"
      unique_id: port_7_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_7_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_7_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_7_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 7"
          switch_port: 7

    - name: "Port 7 Upload Speed"
      unique_id: port_7_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_7_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_7_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_7_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 7"
          switch_port: 7

      # Port 8 Sensors
    - name: "Port 8 Download Speed"
      unique_id: port_8_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_8_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_8_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_8_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 8"
          switch_port: 8

    - name: "Port 8 Upload Speed"
      unique_id: port_8_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_8_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_8_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_8_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 8"
          switch_port: 8

      # Port 9 Sensors
    - name: "Port 9 Download Speed"
      unique_id: port_9_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_9_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_9_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_9_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 9"
          switch_port: 9

    - name: "Port 9 Upload Speed"
      unique_id: port_9_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_9_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_9_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_9_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 9"
          switch_port: 9

      # Port 10 Sensors
    - name: "Port 10 Download Speed"
      unique_id: port_10_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_10_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_10_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_10_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 10"
          switch_port: 10

    - name: "Port 10 Upload Speed"
      unique_id: port_10_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_10_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_10_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_10_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 10"
          switch_port: 10

      # Port 11 Sensors
    - name: "Port 11 Download Speed"
      unique_id: port_11_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_11_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_11_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_11_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 11"
          switch_port: 11

    - name: "Port 11 Upload Speed"
      unique_id: port_11_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_11_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_11_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_11_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 11"
          switch_port: 11

      # Port 12 Sensors
    - name: "Port 12 Download Speed"
      unique_id: port_12_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_12_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_12_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_12_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 12"
          switch_port: 12

    - name: "Port 12 Upload Speed"
      unique_id: port_12_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_12_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_12_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_12_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 12"
          switch_port: 12

  # ===================================================================
  # PORTS 13-18 BANDWIDTH MONITORING
  # ===================================================================
#    - trigger:
#      - platform: state
#        entity_id: 
#          - sensor.switch_port_13_bytes_out
#          - sensor.switch_port_13_bytes_in
#          - sensor.switch_port_14_bytes_out
#          - sensor.switch_port_14_bytes_in
#          - sensor.switch_port_15_bytes_out
#          - sensor.switch_port_15_bytes_in
#          - sensor.switch_port_16_bytes_out
#          - sensor.switch_port_16_bytes_in
#          - sensor.switch_port_17_bytes_out
#          - sensor.switch_port_17_bytes_in
#          - sensor.switch_port_18_bytes_out
#          - sensor.switch_port_18_bytes_in
#        not_to: ['unknown', 'unavailable']
#      - platform: time_pattern
#        seconds: "/30"
#        sensor:
      # Port 13 Sensors
    - name: "Port 13 Download Speed"
      unique_id: port_13_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_13_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_13_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_13_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 13"
          switch_port: 13

    - name: "Port 13 Upload Speed"
      unique_id: port_13_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_13_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_13_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_13_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 13"
          switch_port: 13

      # Port 14 Sensors
    - name: "Port 14 Download Speed"
      unique_id: port_14_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_14_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_14_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_14_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 14"
          switch_port: 14

    - name: "Port 14 Upload Speed"
      unique_id: port_14_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_14_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_14_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_14_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 14"
          switch_port: 14

      # Port 15 Sensors
    - name: "Port 15 Download Speed"
      unique_id: port_15_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_15_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_15_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_15_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 15"
          switch_port: 15

    - name: "Port 15 Upload Speed"
      unique_id: port_15_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_15_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_15_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_15_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 15"
          switch_port: 15

      # Port 16 Sensors
    - name: "Port 16 Download Speed"
      unique_id: port_16_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_16_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_16_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_16_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 16"
          switch_port: 16

    - name: "Port 16 Upload Speed"
      unique_id: port_16_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_16_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_16_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_16_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 16"
          switch_port: 16

      # Port 17 Sensors
    - name: "Port 17 Download Speed"
      unique_id: port_17_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_17_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_17_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_17_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 17"
          switch_port: 17

    - name: "Port 17 Upload Speed"
      unique_id: port_17_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_17_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_17_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_17_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 17"
          switch_port: 17

      # Port 18 Sensors
    - name: "Port 18 Download Speed"
      unique_id: port_18_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_18_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_18_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_18_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 18"
          switch_port: 18

    - name: "Port 18 Upload Speed"
      unique_id: port_18_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_18_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_18_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_18_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 18"
          switch_port: 18

  # ===================================================================
  # PORTS 19-24 BANDWIDTH MONITORING
  # ===================================================================
#    - trigger:
#      - platform: state
#        entity_id: 
#          - sensor.switch_port_19_bytes_out
#          - sensor.switch_port_19_bytes_in
#          - sensor.switch_port_20_bytes_out
#          - sensor.switch_port_20_bytes_in
#          - sensor.switch_port_21_bytes_out
#          - sensor.switch_port_21_bytes_in
#          - sensor.switch_port_22_bytes_out
#          - sensor.switch_port_22_bytes_in
#          - sensor.switch_port_23_bytes_out
#          - sensor.switch_port_23_bytes_in
#          - sensor.switch_port_24_bytes_out
#          - sensor.switch_port_24_bytes_in
#        not_to: ['unknown', 'unavailable']
#      - platform: time_pattern
#        seconds: "/30"
#        sensor:
      # Port 19 Sensors
    - name: "Port 19 Download Speed"
      unique_id: port_19_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_19_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_19_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_19_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 19"
          switch_port: 19

    - name: "Port 19 Upload Speed"
      unique_id: port_19_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_19_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_19_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_19_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 19"
          switch_port: 19

      # Port 20 Sensors
    - name: "Port 20 Download Speed"
      unique_id: port_20_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_20_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_20_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_20_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 20"
          switch_port: 20

    - name: "Port 20 Upload Speed"
      unique_id: port_20_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_20_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_20_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_20_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 20"
          switch_port: 20

      # Port 21 Sensors
    - name: "Port 21 Download Speed"
      unique_id: port_21_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_21_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_21_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_21_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 21"
          switch_port: 21

    - name: "Port 21 Upload Speed"
      unique_id: port_21_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_21_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_21_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_21_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 21"
          switch_port: 21

      # Port 22 Sensors
    - name: "Port 22 Download Speed"
      unique_id: port_22_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_22_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_22_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_22_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 22"
          switch_port: 22

    - name: "Port 22 Upload Speed"
      unique_id: port_22_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_22_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_22_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_22_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 22"
          switch_port: 22

      # Port 23 Sensors
    - name: "Port 23 Download Speed"
      unique_id: port_23_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_23_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_23_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_23_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 23"
          switch_port: 23

    - name: "Port 23 Upload Speed"
      unique_id: port_23_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_23_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_23_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_23_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 23"
          switch_port: 23

      # Port 24 Sensors
    - name: "Port 24 Download Speed"
      unique_id: port_24_download_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_24_bytes_out') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network
      availability: "{{ has_value('sensor.switch_port_24_bytes_out') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_24_bytes_out') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 24"
          switch_port: 24

    - name: "Port 24 Upload Speed"
      unique_id: port_24_upload_speed_fixed
      state: >
          {% set current = states('sensor.switch_port_24_bytes_in') | int(0) %}
          {% set previous = this.attributes.get('previous_bytes', current) %}
          {% set last_update = this.attributes.get('last_update', now().timestamp()) %}
          {% set current_time = now().timestamp() %}
          {% set time_diff = current_time - last_update %}
          {% if current > previous and time_diff > 0 and time_diff < 300 %}
            {{ ((current - previous) * 8 / time_diff / 1000000) | round(3) }}
          {% elif time_diff >= 300 %}
            0
          {% else %}
            {{ this.state | default(0, true) }}
          {% endif %}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network
      availability: "{{ has_value('sensor.switch_port_24_bytes_in') }}"
      attributes:
          previous_bytes: "{{ states('sensor.switch_port_24_bytes_in') | int(0) }}"
          last_update: "{{ now().timestamp() }}"
          device_type: "Unknown - Port 24"
          switch_port: 24

  # ===================================================================
  # TOTAL NETWORK BANDWIDTH AGGREGATION
  # ===================================================================
#    - trigger:
#      - platform: time_pattern
#        seconds: "/30"
#      - platform: state
#        entity_id: 
#          - sensor.port_1_download_speed
#          - sensor.port_2_download_speed
#          - sensor.port_3_download_speed
#          - sensor.port_4_download_speed
#          - sensor.port_5_download_speed
#          - sensor.port_6_download_speed
#          - sensor.port_7_download_speed
#          - sensor.port_8_download_speed
#          - sensor.port_9_download_speed
#          - sensor.port_10_download_speed
#          - sensor.port_11_download_speed
#          - sensor.port_12_download_speed
#          - sensor.port_13_download_speed
#          - sensor.port_14_download_speed
#          - sensor.port_15_download_speed
#          - sensor.port_16_download_speed
#          - sensor.port_17_download_speed
#          - sensor.port_18_download_speed
#          - sensor.port_19_download_speed
#          - sensor.port_20_download_speed
#          - sensor.port_21_download_speed
#          - sensor.port_22_download_speed
#          - sensor.port_23_download_speed
#          - sensor.port_24_download_speed
#        not_to: ['unknown', 'unavailable']
#        sensor:
      # Total Network Download Speed (Fixed - No Self-Reference)
    - name: "Total Network Download"
      unique_id: total_network_download_fixed
      state: >
          {% set ports = range(1, 25) %}
          {% set total = namespace(value=0) %}
          {% for port in ports %}
            {% set sensor_name = 'sensor.port_' ~ port ~ '_download_speed' %}
            {% if has_value(sensor_name) %}
              {% set total.value = total.value + (states(sensor_name) | float(0)) %}
            {% endif %}
          {% endfor %}
          {{ total.value | round(2) }}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:download-network-outline
      attributes:
        active_ports: >
            {% set active_ports = [] %}
            {% for port in range(1, 25) %}
              {% set sensor_name = 'sensor.port_' ~ port ~ '_download_speed' %}
              {% if has_value(sensor_name) and states(sensor_name) | float(0) > 0.1 %}
                {% set active_ports = active_ports + [port] %}
              {% endif %}
            {% endfor %}
            {{ active_ports }}
        port_count: >
            {% set active_ports = [] %}
            {% for port in range(1, 25) %}
              {% set sensor_name = 'sensor.port_' ~ port ~ '_download_speed' %}
              {% if has_value(sensor_name) and states(sensor_name) | float(0) > 0.1 %}
                {% set active_ports = active_ports + [port] %}
              {% endif %}
            {% endfor %}
            {{ active_ports | length }}

      # Total Network Upload Speed (Fixed - No Self-Reference)
    - name: "Total Network Upload"
      unique_id: total_network_upload_fixed
      state: >
          {% set ports = range(1, 25) %}
          {% set total = namespace(value=0) %}
          {% for port in ports %}
            {% set sensor_name = 'sensor.port_' ~ port ~ '_upload_speed' %}
            {% if has_value(sensor_name) %}
              {% set total.value = total.value + (states(sensor_name) | float(0)) %}
            {% endif %}
          {% endfor %}
          {{ total.value | round(2) }}
      unit_of_measurement: "Mbps"
      device_class: data_rate
      state_class: measurement
      icon: mdi:upload-network-outline
      attributes:
          active_ports: >
            {% set active_ports = [] %}
            {% for port in range(1, 25) %}
              {% set sensor_name = 'sensor.port_' ~ port ~ '_upload_speed' %}
              {% if has_value(sensor_name) and states(sensor_name) | float(0) > 0.1 %}
                {% set active_ports = active_ports + [port] %}
              {% endif %}
            {% endfor %}
            {{ active_ports }}
          port_count: >
            {% set active_ports = [] %}
            {% for port in range(1, 25) %}
              {% set sensor_name = 'sensor.port_' ~ port ~ '_upload_speed' %}
              {% if has_value(sensor_name) and states(sensor_name) | float(0) > 0.1 %}
                {% set active_ports = active_ports + [port] %}
              {% endif %}
            {% endfor %}
            {{ active_ports | length }}

  # ===================================================================
  # NETWORK MONITORING AND HEALTH SENSORS
  # ===================================================================
#    - trigger:
#      - platform: time_pattern
#        minutes: "/5"
#        sensor:
#      # High Activity Ports Detection
    - name: "High Activity Network Ports"
      unique_id: high_activity_network_ports_fixed
      state: >
          {% set high_activity = namespace(count=0) %}
          {% for port in range(1, 25) %}
            {% set download_sensor = 'sensor.port_' ~ port ~ '_download_speed' %}
            {% set upload_sensor = 'sensor.port_' ~ port ~ '_upload_speed' %}
            {% if has_value(download_sensor) and has_value(upload_sensor) %}
              {% set download = states(download_sensor) | float(0) %}
              {% set upload = states(upload_sensor) | float(0) %}
              {% if download > 1 or upload > 1 %}
                {% set high_activity.count = high_activity.count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ high_activity.count }}
      unit_of_measurement: "ports"
      icon: mdi:ethernet
      attributes:
        port_details: >
            {% set high_activity_ports = [] %}
            {% for port in range(1, 25) %}
              {% set download_sensor = 'sensor.port_' ~ port ~ '_download_speed' %}
              {% set upload_sensor = 'sensor.port_' ~ port ~ '_upload_speed' %}
              {% if has_value(download_sensor) and has_value(upload_sensor) %}
                {% set download = states(download_sensor) | float(0) %}
                {% set upload = states(upload_sensor) | float(0) %}
                {% if download > 1 or upload > 1 %}
                  {% set high_activity_ports = high_activity_ports + [{
                    'port': port,
                    'download_mbps': download | round(2),
                    'upload_mbps': upload | round(2),
                    'total_mbps': (download + upload) | round(2)
                  }] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ high_activity_ports }}

      # Network Health Score
    - name: "Network Bandwidth Health"
      unique_id: network_bandwidth_health_fixed
      state: >
          {% set total_download = states('sensor.total_network_download') | float(0) %}
          {% set total_upload = states('sensor.total_network_upload') | float(0) %}
          {% set total_bandwidth = total_download + total_upload %}
          {% set excellent_threshold = 100 %}
          {% set good_threshold = 50 %}
          {% set fair_threshold = 10 %}
          {% if total_bandwidth > excellent_threshold %}
            excellent
          {% elif total_bandwidth > good_threshold %}
            good
          {% elif total_bandwidth > fair_threshold %}
            fair
          {% else %}
            poor
          {% endif %}
      icon: >
          {% set health = states('sensor.network_bandwidth_health') %}
          {% if health == 'excellent' %}
            mdi:network-strength-4
          {% elif health == 'good' %}
            mdi:network-strength-3
          {% elif health == 'fair' %}
            mdi:network-strength-2
          {% else %}
            mdi:network-strength-1
          {% endif %}
      attributes:
          total_download_mbps: "{{ states('sensor.total_network_download') | float(0) | round(2) }}"
          total_upload_mbps: "{{ states('sensor.total_network_upload') | float(0) | round(2) }}"
          total_bandwidth_mbps: >
            {{ (states('sensor.total_network_download') | float(0) + 
                states('sensor.total_network_upload') | float(0)) | round(2) }}
          active_devices: "{{ states('sensor.high_activity_network_ports') | int(0) }}"
      
      
   
#-----------------------------------------------------------------------------------------------------------      
# Template sensors for comprehensive energy analysis
# Added by Claude.ai on 31 July 2025
# Current Power in kW
    - name: "Current Power Usage kW"
      state: >
        {{ (states('sensor.efergy_power_usage') | float / 1000) | round(3) }}
      unit_of_measurement: "kW"
      device_class: power
      icon: mdi:flash
    
    # Hourly Cost
    - name: "Energy Cost Hourly"
      state: >
        {{ (states('sensor.energy_hourly') | float * states('input_number.electricity_rate') | float) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:currency-usd
      attributes:
        usage_kwh: "{{ states('sensor.energy_hourly') }}"
        rate: "{{ states('input_number.electricity_rate') }}"
    
    # Daily Cost
    - name: "Energy Cost Daily"
      state: >
        {% set usage = states('sensor.energy_daily') | float %}
        {% set rate = states('input_number.electricity_rate') | float %}
        {% set connection_fee = states('input_number.daily_connection_fee') | float %}
        {{ ((usage * rate) + connection_fee) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:currency-usd
      attributes:
        usage_kwh: "{{ states('sensor.energy_daily') }}"
        energy_cost: "{{ (states('sensor.energy_daily') | float * states('input_number.electricity_rate') | float) | round(2) }}"
        connection_fee: "{{ states('input_number.daily_connection_fee') }}"
    
    # Weekly Cost
    - name: "Energy Cost Weekly"
      state: >
        {% set usage = states('sensor.energy_weekly') | float %}
        {% set rate = states('input_number.electricity_rate') | float %}
        {% set connection_fee = states('input_number.daily_connection_fee') | float * 7 %}
        {{ ((usage * rate) + connection_fee) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:currency-usd
    
    # Monthly Cost
    - name: "Energy Cost Monthly"
      state: >
        {% set usage = states('sensor.energy_monthly') | float %}
        {% set rate = states('input_number.electricity_rate') | float %}
        {% set connection_fee = states('input_number.daily_connection_fee') | float * 30 %}
        {{ ((usage * rate) + connection_fee) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:currency-usd
      attributes:
        usage_kwh: "{{ states('sensor.energy_monthly') }}"
        projected_annual: "{{ (states('sensor.energy_cost_monthly') | float * 12) | round(2) }}"
    
    # Quarterly Cost
    - name: "Energy Cost Quarterly"
      state: >
        {% set usage = states('sensor.energy_quarterly') | float %}
        {% set rate = states('input_number.electricity_rate') | float %}
        {% set connection_fee = states('input_number.daily_connection_fee') | float * 90 %}
        {{ ((usage * rate) + connection_fee) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:currency-usd
    
    # Yearly Cost
    - name: "Energy Cost Yearly"
      state: >
        {% set usage = states('sensor.energy_yearly') | float %}
        {% set rate = states('input_number.electricity_rate') | float %}
        {% set connection_fee = states('input_number.daily_connection_fee') | float * 365 %}
        {{ ((usage * rate) + connection_fee) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:currency-usd
    
    # Comparison Sensors
    - name: "Daily Usage Comparison"
      state: >
        {% set today = states('sensor.energy_daily') | float %}
        {% set yesterday = states('sensor.energy_daily_previous') | float %}
        {% if yesterday > 0 %}
          {{ (((today - yesterday) / yesterday) * 100) | round(1) }}
        {% else %}
          0
        {% endif %}
      unit_of_measurement: "%"
      icon: mdi:compare-horizontal
      attributes:
        today_kwh: "{{ states('sensor.energy_daily') }}"
        yesterday_kwh: "{{ states('sensor.energy_daily_previous') }}"
        difference_kwh: "{{ (states('sensor.energy_daily') | float - states('sensor.energy_daily_previous') | float) | round(2) }}"
    
    - name: "Monthly Usage Comparison"
      state: >
        {% set current = states('sensor.energy_monthly') | float %}
        {% set previous = states('sensor.energy_monthly_previous') | float %}
        {% if previous > 0 %}
          {{ (((current - previous) / previous) * 100) | round(1) }}
        {% else %}
          0
        {% endif %}
      unit_of_measurement: "%"
      icon: mdi:compare-horizontal
    
    # Efficiency Metrics
    - name: "Average Daily Usage"
      state: >
        {% set monthly = states('sensor.energy_monthly') | float %}
        {% set days = now().day %}
        {{ (monthly / days) | round(2) }}
      unit_of_measurement: "kWh/day"
      icon: mdi:chart-line
    
    - name: "Projected Monthly Cost"
      state: >
        {% set daily_avg = states('sensor.average_daily_usage') | float %}
        {% set rate = states('input_number.electricity_rate') | float %}
        {% set connection_fee = states('input_number.daily_connection_fee') | float * 30 %}
        {{ ((daily_avg * 30 * rate) + connection_fee) | round(2) }}
      unit_of_measurement: "R"
      icon: mdi:trending-up
#-----------------------------------------------------------------------------------------------------------            










